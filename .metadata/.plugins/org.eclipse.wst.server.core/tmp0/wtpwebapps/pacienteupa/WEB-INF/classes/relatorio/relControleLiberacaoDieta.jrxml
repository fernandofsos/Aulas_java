<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="report5" language="groovy" pageWidth="842" pageHeight="595" orientation="Landscape" columnWidth="802" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20">
	<property name="ireport.zoom" value="1.4641000000000033"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<style name="Title" isDefault="false" fontName="Arial" fontSize="26" isBold="true" pdfFontName="Helvetica-Bold"/>
	<style name="SubTitle" isDefault="false" forecolor="#666666" fontName="Arial" fontSize="18"/>
	<style name="Column header" isDefault="false" forecolor="#666666" fontName="Arial" fontSize="12" isBold="true"/>
	<style name="Detail" isDefault="false" fontName="Arial" fontSize="12"/>
	<parameter name="CAMINHO_IMG_BRASAO" class="java.lang.String"/>
	<parameter name="CAMINHO_IMG_UPA" class="java.lang.String"/>
	<queryString>
		<![CDATA[SELECT
	(select vlr_parametro from medpoint.t_parametro where isn_parametro = 10) as endereco_completo,
	(SELECT VLR_PARAMETRO FROM MEDPOINT.T_PARAMETRO WHERE ISN_PARAMETRO = 13) AS DSC_UNIDADE,
	clin.isn_clinica,
	clin.dsc_clinica,
	tleito.dsc_leito,
	pacie.dsc_nome,
	to_char(pacie.dat_nascimento, 'DD/MM/YYYY') || ' - '|| medpoint.idade2(pacie.dat_nascimento,current_date) AS dat_nascimento_idade,
	ttt.dsc_prescricao,
	CASE WHEN ttt.dat_apz IS NOT NULL THEN
		CASE WHEN ttt.hora_inicio = 0 THEN '  ' ELSE ttt.hora_inicio || 'h' END || ' | ' ||
		array_to_string(array_remove(string_to_array(coalesce(ttt.flg_apz_08,'-') || ',' || coalesce(ttt.flg_apz_09,'-') || ',' || coalesce(ttt.flg_apz_10,'-') || ',' || coalesce(ttt.flg_apz_11,'-') || ','
		|| coalesce(ttt.flg_apz_12,'-') || ',' || coalesce(ttt.flg_apz_13,'-') || ',' || coalesce(ttt.flg_apz_14,'-') || ',' || coalesce(ttt.flg_apz_15,'-') || ','
		|| coalesce(ttt.flg_apz_16,'-') || ',' || coalesce(ttt.flg_apz_17,'-') || ',' || coalesce(ttt.flg_apz_18,'-') || ',' || coalesce(ttt.flg_apz_19,'-') || ','
		|| coalesce(ttt.flg_apz_20,'-') || ',' || coalesce(ttt.flg_apz_21,'-') || ',' || coalesce(ttt.flg_apz_22,'-') || ',' || coalesce(ttt.flg_apz_23,'-') || ','
		|| coalesce(ttt.flg_apz_24,'-') || ',' || coalesce(ttt.flg_apz_01,'-') || ',' || coalesce(ttt.flg_apz_02,'-') || ',' || coalesce(ttt.flg_apz_03,'-') || ','
		|| coalesce(ttt.flg_apz_04,'-') || ',' || coalesce(ttt.flg_apz_05,'-') || ',' || coalesce(ttt.flg_apz_06,'-') || ',' || coalesce(ttt.flg_apz_07,'-'),','), '-'),'_') || ''
	ELSE ' '
	END AS aprazamento
FROM (
select * from (

select distinct base.isn_prescricao_pep, base.isn_prescricao_tipo, base.isn_internacao, base.dat_apz, base.isn_internacao_leito, pitem.DSC_PRESCRICAO,
pitem.hora_inicio, pitem.flg_apz_01, pitem.flg_apz_02, pitem.flg_apz_03, pitem.flg_apz_04, pitem.flg_apz_05, pitem.flg_apz_06, pitem.flg_apz_07, pitem.flg_apz_08, pitem.flg_apz_09, pitem.flg_apz_10,
pitem.flg_apz_11, pitem.flg_apz_12, pitem.flg_apz_13, pitem.flg_apz_14, pitem.flg_apz_15, pitem.flg_apz_16, pitem.flg_apz_17, pitem.flg_apz_18, pitem.flg_apz_19, pitem.flg_apz_20, pitem.flg_apz_21,
pitem.flg_apz_22, pitem.flg_apz_23, pitem.flg_apz_24
from medpoint.t_prescricao_pep base
inner join ( select t2.pep, t2.isn_internacao from ( with lista as ( SELECT leito.isn_internacao as inter FROM medpoint.t_internacao_leito leito WHERE leito.dat_alta IS NULL)
		select
			isn_prescricao_pep as pep,
			rank() over(partition by isn_internacao order by isn_prescricao_pep desc) as ordem,
			isn_internacao
		from
			medpoint.t_prescricao_pep prpep
			inner join lista on lista.inter = prpep.isn_internacao
		where
			ISN_PRESCRICAO_TIPO = 8 and
			dat_conclusao notnull
	) t2 where t2.ordem = 1
	) completa on base.isn_prescricao_pep >= completa.pep and base.isn_internacao = completa.isn_internacao
inner join medpoint.t_prescricao_pep_item pitem on pitem.ISN_TIPO_PRESCRICAO = 1 and base.isn_prescricao_pep = pitem.isn_prescricao_pep and pitem.FLG_ATIVO='S' and pitem.ISN_PRESCRICAO_PEP_IS is null
where base.dat_conclusao notnull

union

select distinct base2.isn_prescricao_pep, base2.isn_prescricao_tipo, base2.isn_internacao, base2.dat_apz, base2.isn_internacao_leito, pitem.DSC_PRESCRICAO,
pitem.hora_inicio, pitem.flg_apz_01, pitem.flg_apz_02, pitem.flg_apz_03, pitem.flg_apz_04, pitem.flg_apz_05, pitem.flg_apz_06, pitem.flg_apz_07, pitem.flg_apz_08, pitem.flg_apz_09, pitem.flg_apz_10,
pitem.flg_apz_11, pitem.flg_apz_12, pitem.flg_apz_13, pitem.flg_apz_14, pitem.flg_apz_15, pitem.flg_apz_16, pitem.flg_apz_17, pitem.flg_apz_18, pitem.flg_apz_19, pitem.flg_apz_20, pitem.flg_apz_21,
pitem.flg_apz_22, pitem.flg_apz_23, pitem.flg_apz_24
from medpoint.t_prescricao_pep base2
inner join medpoint.t_prescricao_pep_item pitem on pitem.ISN_TIPO_PRESCRICAO = 1 and base2.isn_prescricao_pep = pitem.isn_prescricao_pep and pitem.FLG_ATIVO='S' and pitem.ISN_PRESCRICAO_PEP_IS is null
where
	base2.isn_internacao in ( SELECT isn_internacao FROM medpoint.t_internacao_leito leito WHERE leito.dat_alta IS NULL) and
	base2.isn_internacao not in ( select tt4.isn_internacao  from ( with lista as ( SELECT leito.isn_internacao as inter FROM medpoint.t_internacao_leito leito WHERE leito.dat_alta IS NULL )
		select prpep.isn_internacao
			from
				medpoint.t_prescricao_pep prpep
				inner join lista on lista.inter = prpep.isn_internacao
		where
			ISN_PRESCRICAO_TIPO = 8 and
			dat_conclusao notnull) tt4 )

	and base2.ISN_PRESCRICAO_TIPO <> 8 and base2.dat_conclusao notnull
) tt
) ttt

inner join medpoint.t_internacao_leito inter_leito on inter_leito.isn_internacao = ttt.isn_internacao and inter_leito.dat_alta isnull
inner join medpoint.t_internacao internacao on internacao.isn_internacao = inter_leito.isn_internacao
INNER JOIN medpoint.t_leito tleito ON tleito.isn_leito = inter_leito.isn_leito
INNER JOIN medpoint.t_enfermaria enf ON enf.isn_enfermaria = tleito.isn_enfermaria
INNER JOIN medpoint.t_clinica clin ON clin.isn_clinica = enf.isn_clinica
INNER JOIN medpoint.t_paciente pacie ON pacie.isn_paciente = internacao.isn_paciente
ORDER BY clin.dsc_clinica, tleito.dsc_leito;]]>
	</queryString>
	<field name="endereco_completo" class="java.lang.String"/>
	<field name="dsc_unidade" class="java.lang.String"/>
	<field name="isn_clinica" class="java.lang.Integer"/>
	<field name="dsc_clinica" class="java.lang.String"/>
	<field name="dsc_leito" class="java.lang.String"/>
	<field name="dsc_nome" class="java.lang.String"/>
	<field name="dat_nascimento_idade" class="java.lang.String"/>
	<field name="dsc_prescricao" class="java.lang.String"/>
	<field name="aprazamento" class="java.lang.String"/>
	<variable name="SOMA_ISN_CLINICA" class="java.lang.String" resetType="Group" resetGroup="dsc_clinica" calculation="Sum">
		<variableExpression><![CDATA[$F{isn_clinica}]]></variableExpression>
	</variable>
	<group name="dsc_clinica">
		<groupExpression><![CDATA[$F{dsc_clinica}]]></groupExpression>
		<groupHeader>
			<band height="37">
				<line>
					<reportElement x="0" y="34" width="802" height="1"/>
				</line>
				<staticText>
					<reportElement x="0" y="20" width="27" height="15"/>
					<textElement>
						<font isBold="true"/>
					</textElement>
					<text><![CDATA[Leito]]></text>
				</staticText>
				<staticText>
					<reportElement x="28" y="20" width="88" height="15"/>
					<textElement>
						<font isBold="true"/>
					</textElement>
					<text><![CDATA[Nome Paciente]]></text>
				</staticText>
				<line>
					<reportElement x="0" y="19" width="802" height="1"/>
				</line>
				<staticText>
					<reportElement x="317" y="5" width="51" height="15"/>
					<textElement>
						<font isBold="true"/>
					</textElement>
					<text><![CDATA[CLÍNICA:]]></text>
				</staticText>
				<staticText>
					<reportElement x="223" y="20" width="100" height="15"/>
					<textElement>
						<font isBold="true"/>
					</textElement>
					<text><![CDATA[Data Nasc. - Idade]]></text>
				</staticText>
				<staticText>
					<reportElement x="352" y="20" width="100" height="16"/>
					<textElement>
						<font isBold="true"/>
					</textElement>
					<text><![CDATA[Prescrição da Dieta]]></text>
				</staticText>
				<staticText>
					<reportElement x="590" y="20" width="165" height="15"/>
					<textElement>
						<font isBold="true"/>
					</textElement>
					<text><![CDATA[Aprazamento Enfermagem]]></text>
				</staticText>
				<textField>
					<reportElement x="367" y="5" width="435" height="15"/>
					<textElement/>
					<textFieldExpression class="java.lang.String"><![CDATA[$F{dsc_clinica}]]></textFieldExpression>
				</textField>
			</band>
		</groupHeader>
		<groupFooter>
			<band height="3"/>
		</groupFooter>
	</group>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band splitType="Stretch"/>
	</title>
	<pageHeader>
		<band height="95" splitType="Stretch">
			<staticText>
				<reportElement x="1" y="2" width="351" height="17"/>
				<textElement>
					<font fontName="SansSerif" size="11" isBold="true"/>
				</textElement>
				<text><![CDATA[INSTITUTO DE SAÚDE E GESTÃO HOSPITALAR - ISGH ]]></text>
			</staticText>
			<image>
				<reportElement x="676" y="3" width="117" height="33"/>
				<imageExpression class="java.lang.String"><![CDATA[$P{CAMINHO_IMG_BRASAO}]]></imageExpression>
			</image>
			<staticText>
				<reportElement x="1" y="18" width="338" height="17"/>
				<textElement>
					<font fontName="SansSerif" size="11" isBold="true"/>
				</textElement>
				<text><![CDATA[UNIDADE DE PRONTO ATENDIMENTO - UPA]]></text>
			</staticText>
			<image>
				<reportElement x="551" y="2" width="127" height="33"/>
				<imageExpression class="java.lang.String"><![CDATA[$P{CAMINHO_IMG_UPA}]]></imageExpression>
			</image>
			<staticText>
				<reportElement x="1" y="34" width="290" height="17"/>
				<textElement>
					<font fontName="SansSerif" size="8" isBold="true"/>
				</textElement>
				<text><![CDATA[ORGANIZAÇÃO SOCIAL SAÚDE]]></text>
			</staticText>
			<textField>
				<reportElement x="551" y="36" width="242" height="16"/>
				<box leftPadding="4"/>
				<textElement>
					<font fontName="SansSerif" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{dsc_unidade}.toUpperCase()]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="118" y="53" width="555" height="20"/>
				<textElement textAlignment="Center">
					<font size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[RELATÓRIO DE CONTROLE DE LIBERAÇÃO DE DIETA]]></text>
			</staticText>
			<staticText>
				<reportElement x="1" y="73" width="72" height="15"/>
				<textElement>
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Emitido em:]]></text>
			</staticText>
			<textField pattern="dd/MM/yyyy HH:mm:ss">
				<reportElement x="73" y="73" width="163" height="15"/>
				<textElement/>
				<textFieldExpression class="java.util.Date"><![CDATA[new java.util.Date()]]></textFieldExpression>
			</textField>
		</band>
	</pageHeader>
	<detail>
		<band height="17" splitType="Prevent">
			<textField isStretchWithOverflow="true" isBlankWhenNull="true">
				<reportElement x="7" y="0" width="62" height="16"/>
				<textElement>
					<font size="10"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{dsc_leito}]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" isBlankWhenNull="true">
				<reportElement x="590" y="0" width="212" height="16"/>
				<textElement>
					<font size="10"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{aprazamento}]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" isBlankWhenNull="true">
				<reportElement x="28" y="0" width="190" height="16"/>
				<textElement>
					<font size="10"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{dsc_nome}]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" isBlankWhenNull="true">
				<reportElement x="223" y="0" width="129" height="16"/>
				<textElement>
					<font size="10"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{dat_nascimento_idade}]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" isBlankWhenNull="true">
				<reportElement x="352" y="0" width="228" height="16"/>
				<textElement>
					<font size="10"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{dsc_prescricao}]]></textFieldExpression>
			</textField>
			<line>
				<reportElement positionType="FixRelativeToBottom" mode="Opaque" x="0" y="16" width="802" height="1"/>
				<graphicElement>
					<pen lineWidth="1.0" lineStyle="Dotted"/>
				</graphicElement>
			</line>
		</band>
	</detail>
	<columnFooter>
		<band splitType="Stretch"/>
	</columnFooter>
	<pageFooter>
		<band height="56" splitType="Stretch">
			<line>
				<reportElement x="0" y="25" width="802" height="1"/>
			</line>
			<textField evaluationTime="Report">
				<reportElement x="392" y="8" width="100" height="16"/>
				<textElement/>
				<textFieldExpression class="java.lang.String"><![CDATA[$V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="374" y="8" width="17" height="16"/>
				<textElement textAlignment="Center"/>
				<text><![CDATA[de]]></text>
			</staticText>
			<textField>
				<reportElement x="339" y="8" width="35" height="16"/>
				<textElement textAlignment="Right"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="52" y="27" width="681" height="14"/>
				<textElement textAlignment="Center">
					<font fontName="SansSerif"/>
				</textElement>
				<text><![CDATA[Unidade mantida com recursos públicos, provenientes de seus impostos e contribuições sociais.]]></text>
			</staticText>
			<textField>
				<reportElement x="28" y="41" width="727" height="15"/>
				<textElement textAlignment="Center"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{endereco_completo}]]></textFieldExpression>
			</textField>
		</band>
	</pageFooter>
	<summary>
		<band splitType="Stretch"/>
	</summary>
</jasperReport>
