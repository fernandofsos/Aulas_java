<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="relNovaPrescricaoPep" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="5" bottomMargin="5">
	<property name="ireport.zoom" value="1.5"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<parameter name="p1" class="java.lang.Integer"/>
	<parameter name="data_atual" class="java.lang.String" isForPrompting="false">
		<defaultValueExpression><![CDATA[new java.text.SimpleDateFormat("dd/MM/yyyy HH:mm:ss").format(new Date())]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[SELECT  TP.DSC_TIPO_PRESCRICAO,
	PP.ISN_PRESCRICAO_PEP,
	PP.ISN_INTERNACAO,
CASE WHEN (ppi.ISN_PRESCRICAO_PEP_IS is null and (pt.flg_mpp is null or pt.flg_mpp is false or ppi.ISN_TIPO_PRESCRICAO = 43))
		THEN upper(ppi.DSC_PRESCRICAO) || ' ' ||
			CASE WHEN ppi.FLG_SE_NECESSARIO = 'S'
				THEN ' - ** SE NECESSÁRIO **' ELSE ''
			END
			||' '||
			CASE WHEN ppi.FLG_ACM = 'S'
				THEN ' - ** ACM **' ELSE ''
			END
			||' '||
			CASE WHEN D.DIAS is null THEN '' ELSE '(**D'||D.DIAS||'**)'
			END
		ELSE NULL
		END || case when (ppi.dsc_complemento is null or ppi.dsc_complemento = '') then '' else '  |  ' || ppi.dsc_complemento end as dsc_prescricao,
       CASE WHEN (ppi.ISN_PRESCRICAO_PEP_IS is null and pt.flg_mpp is true and ppi.ISN_TIPO_PRESCRICAO != 43)
		THEN upper(ppi.DSC_PRESCRICAO) || ' ' ||
		CASE WHEN ppi.FLG_SE_NECESSARIO = 'S'
		THEN ' - ** SE NECESSÁRIO **' ELSE ''
		END ||' '||
		CASE WHEN ppi.FLG_ACM = 'S'
		THEN ' - ** ACM **' ELSE ''
		END ||' '||
		CASE WHEN D.DIAS is null
		THEN ''
		ELSE '(**D'||D.DIAS||'**)'
		END
	ELSE NULL
	END || case when (ppi.dsc_complemento is null or ppi.dsc_complemento = '') then '' else '  |  ' || ppi.dsc_complemento end as dsc_prescricao_mpp,

       CASE WHEN (ppi.ISN_PRESCRICAO_PEP_IS is not null and (pt.flg_mpp is null or pt.flg_mpp is false or ppi.ISN_TIPO_PRESCRICAO = 43))
		THEN upper(ppi.DSC_PRESCRICAO)|| ' ' ||
		CASE WHEN ppi.FLG_SE_NECESSARIO = 'S' THEN ' - ** SE NECESSÁRIO **' ELSE ''
		END ||' '||
		CASE WHEN ppi.FLG_ACM = 'S' THEN ' - ** ACM **' ELSE ''
		END ||' '||
		CASE WHEN D.DIAS is null THEN '' ELSE '(**D'||D.DIAS||'**)'
		END ||'  '|| '(SUSPENSO)' ELSE NULL
		END ||
	case when (ppi.dsc_complemento is null or ppi.dsc_complemento = '') then '' else '  |  ' || ppi.dsc_complemento end as DSC_DESCRICAO_SUSPENSAO,

       CASE WHEN (ppi.ISN_PRESCRICAO_PEP_IS is not null and pt.flg_mpp is true and ppi.ISN_TIPO_PRESCRICAO != 43) THEN upper(ppi.DSC_PRESCRICAO)|| ' ' || CASE WHEN ppi.FLG_SE_NECESSARIO = 'S' THEN ' - ** SE NECESSÁRIO **' ELSE '' END ||' '|| CASE WHEN ppi.FLG_ACM = 'S' THEN ' - ** ACM **' ELSE '' END ||' '|| CASE WHEN D.DIAS is null THEN '' ELSE '(**D'||D.DIAS||'**)' END ||'  '|| '(SUSPENSO)' ELSE NULL END || case when (ppi.dsc_complemento is null or ppi.dsc_complemento = '') then '' else '  |  ' || ppi.dsc_complemento end as DSC_DESCRICAO_SUSPENSAO_MPP,
       PPI.DAT_CADASTRO AS DAT_CAD_PRESCRICAO,
       coalesce(usrc.dsc_usuario, usr.dsc_usuario) AS NOM_PROFISSIONAL,
       PPI.ISN_PRESCRICAO_PEP_ITEM,
	   PPI.ISN_PRESCRICAO_PEP_IS,
	   PP.DAT_PRESCRICAO,
       tp.isn_tipo_prescricao,
       ppi.isn_dieta,
(case when dz.dat_inicial is null then '' else (' / (D' ||
 regexp_replace(medpoint.seconds_dd_hh_mi((extract (epoch from age(to_char((case when dz.dat_final is null then $P{data_atual}::timestamp else dz.dat_final end),'dd/MM/yyyy HH24:MI:SS')::timestamp, to_char(dz.dat_inicial,'dd/MM/yyyy HH24:MI:SS')::timestamp))::integer))
 ,'dias', '-') || ')') end) as QTD_DIAS_DIETA_ZERO
FROM MEDPOINT.T_PRESCRICAO_PEP_ITEM PPI
 LEFT JOIN
    (select
        a.isn_internacao,
        b.isn_produto_almox,
        date(date_trunc('day', current_date)) - date(date_trunc('day', a.dat_inicio)) dias
    from
        medpoint.t_ficha a,
        medpoint.t_ficha_item b
    where
        a.isn_ficha = b.isn_ficha and
        date(date(a.dat_inicio) + b.num_dias_validade_ficha::integer) >= date(date_trunc('day', current_date)) and a.isn_internacao = $P{p1}::integer
         ) as D ON ppi.isn_produto_almox = D.isn_produto_almox
    INNER JOIN MEDPOINT.T_PRESCRICAO_PEP PP ON PPI.ISN_PRESCRICAO_PEP = PP.ISN_PRESCRICAO_PEP
    INNER JOIN MEDPOINT.T_TIPO_PRESCRICAO TP ON TP.ISN_TIPO_PRESCRICAO = PPI.ISN_TIPO_PRESCRICAO
    INNER JOIN SEGURANCA.T_USUARIO USR ON USR.ISN_USUARIO = PP.ISN_PROFISSIONAL
    left join  almox.t_produto pt on pt.isn_produto = ppi.isn_produto_almox
    left  join seguranca.t_usuario usrc on usrc.isn_usuario = pp.isn_profissional_concl
    INNER JOIN medpoint.T_PRESCRICAO_TIPO K ON PP.ISN_PRESCRICAO_TIPO = K.ISN_PRESCRICAO_TIPO
    LEFT JOIN MEDPOINT.T_PRESCRICAO_PEP_ITEM_DIETA_ZERO DZ ON DZ.ISN_PRESCRICAO_PEP_ITEM_DIETA_ZERO = ppi.ISN_PRESCRICAO_PEP_ITEM_DIETA_ZERO
WHERE PP.ISN_INTERNACAO = $P{p1}::integer AND PPI.FLG_ATIVO = 'S' AND PP.DAT_CONCLUSAO IS NOT NULL
ORDER BY PP.DAT_PRESCRICAO asc]]>
	</queryString>
	<field name="dsc_tipo_prescricao" class="java.lang.String"/>
	<field name="isn_prescricao_pep" class="java.lang.Integer"/>
	<field name="isn_internacao" class="java.lang.Integer"/>
	<field name="dsc_prescricao" class="java.lang.String"/>
	<field name="dsc_prescricao_mpp" class="java.lang.String"/>
	<field name="dsc_descricao_suspensao" class="java.lang.String"/>
	<field name="dsc_descricao_suspensao_mpp" class="java.lang.String"/>
	<field name="dat_cad_prescricao" class="java.sql.Timestamp"/>
	<field name="nom_profissional" class="java.lang.String"/>
	<field name="isn_prescricao_pep_item" class="java.lang.Integer"/>
	<field name="isn_prescricao_pep_is" class="java.lang.Integer"/>
	<field name="dat_prescricao" class="java.sql.Timestamp"/>
	<field name="isn_tipo_prescricao" class="java.lang.Integer"/>
	<field name="isn_dieta" class="java.lang.Integer"/>
	<field name="qtd_dias_dieta_zero" class="java.lang.String"/>
	<group name="prescricao">
		<groupExpression><![CDATA[$F{isn_prescricao_pep}]]></groupExpression>
		<groupHeader>
			<band height="30">
				<staticText>
					<reportElement positionType="Float" x="424" y="15" width="131" height="15"/>
					<box leftPadding="2">
						<topPen lineWidth="1.0"/>
						<bottomPen lineWidth="1.0"/>
						<rightPen lineWidth="1.0"/>
					</box>
					<textElement>
						<font isBold="true"/>
					</textElement>
					<text><![CDATA[Hora do Aprazamento]]></text>
				</staticText>
				<staticText>
					<reportElement stretchType="RelativeToBandHeight" x="386" y="0" width="38" height="15"/>
					<box leftPadding="2">
						<leftPen lineWidth="0.0"/>
					</box>
					<textElement>
						<font isBold="true"/>
					</textElement>
					<text><![CDATA[Data:]]></text>
				</staticText>
				<textField isStretchWithOverflow="true" pattern="dd/MM/yyyy HH:mm" isBlankWhenNull="true">
					<reportElement stretchType="RelativeToBandHeight" x="424" y="0" width="131" height="15"/>
					<textElement/>
					<textFieldExpression class="java.sql.Timestamp"><![CDATA[$F{dat_prescricao}]]></textFieldExpression>
				</textField>
				<textField isStretchWithOverflow="true" isBlankWhenNull="true">
					<reportElement stretchType="RelativeToBandHeight" x="51" y="0" width="335" height="15"/>
					<textElement/>
					<textFieldExpression class="java.lang.String"><![CDATA[$F{nom_profissional}]]></textFieldExpression>
				</textField>
				<staticText>
					<reportElement stretchType="RelativeToBandHeight" x="0" y="0" width="51" height="15"/>
					<box leftPadding="0">
						<leftPen lineWidth="0.0"/>
					</box>
					<textElement>
						<font isBold="true"/>
					</textElement>
					<text><![CDATA[Médico:]]></text>
				</staticText>
				<staticText>
					<reportElement positionType="Float" x="113" y="15" width="311" height="15"/>
					<box leftPadding="2">
						<topPen lineWidth="1.0"/>
						<leftPen lineWidth="1.0"/>
						<bottomPen lineWidth="1.0"/>
						<rightPen lineWidth="1.0"/>
					</box>
					<textElement>
						<font isBold="true"/>
					</textElement>
					<text><![CDATA[Prescrição]]></text>
				</staticText>
				<staticText>
					<reportElement positionType="Float" x="0" y="15" width="113" height="15"/>
					<box leftPadding="2">
						<topPen lineWidth="1.0"/>
						<leftPen lineWidth="1.0"/>
						<bottomPen lineWidth="1.0"/>
						<rightPen lineWidth="1.0"/>
					</box>
					<textElement>
						<font isBold="true"/>
					</textElement>
					<text><![CDATA[Tipos]]></text>
				</staticText>
			</band>
		</groupHeader>
		<groupFooter>
			<band/>
		</groupFooter>
	</group>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band splitType="Stretch"/>
	</title>
	<pageHeader>
		<band splitType="Stretch"/>
	</pageHeader>
	<columnHeader>
		<band splitType="Stretch"/>
	</columnHeader>
	<detail>
		<band height="16" splitType="Stretch">
			<textField isStretchWithOverflow="true" isBlankWhenNull="true">
				<reportElement stretchType="RelativeToBandHeight" x="424" y="0" width="131" height="15" isPrintWhenDetailOverflows="true"/>
				<box leftPadding="2">
					<leftPen lineWidth="0.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="1.0"/>
				</box>
				<textElement/>
			</textField>
			<textField>
				<reportElement stretchType="RelativeToBandHeight" mode="Transparent" x="0" y="0" width="113" height="15" isPrintWhenDetailOverflows="true" backcolor="#FFFFFF"/>
				<box>
					<leftPen lineWidth="1.0" lineStyle="Solid"/>
					<bottomPen lineWidth="1.0" lineStyle="Solid"/>
				</box>
				<textElement/>
				<textFieldExpression class="java.lang.String"><![CDATA["  "+$F{dsc_tipo_prescricao}]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" isBlankWhenNull="true">
				<reportElement stretchType="RelativeToBandHeight" x="113" y="0" width="311" height="15">
					<printWhenExpression><![CDATA[$F{isn_prescricao_pep_is} == null && $F{dsc_prescricao_mpp} != null]]></printWhenExpression>
				</reportElement>
				<box leftPadding="0" bottomPadding="0">
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="0.0"/>
				</box>
				<textElement markup="html">
					<font fontName="SansSerif" size="8" isBold="true" isItalic="false" isUnderline="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{dsc_prescricao_mpp}.toUpperCase() +
($F{isn_tipo_prescricao}.equals(1) && $F{isn_dieta}.equals(4)?$F{qtd_dias_dieta_zero}.toUpperCase():"")]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" isBlankWhenNull="true">
				<reportElement stretchType="RelativeToBandHeight" x="113" y="0" width="311" height="15">
					<printWhenExpression><![CDATA[$F{isn_prescricao_pep_is} != null  && $F{dsc_descricao_suspensao_mpp} != null]]></printWhenExpression>
				</reportElement>
				<box leftPadding="0" bottomPadding="0">
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="0.0"/>
				</box>
				<textElement markup="html">
					<font fontName="SansSerif" size="8" isStrikeThrough="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{dsc_descricao_suspensao_mpp}.toUpperCase() +
($F{isn_tipo_prescricao}.equals(1) && $F{isn_dieta}.equals(4)?$F{qtd_dias_dieta_zero}.toUpperCase():"")]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" isBlankWhenNull="true">
				<reportElement stretchType="RelativeToBandHeight" x="113" y="0" width="311" height="15">
					<printWhenExpression><![CDATA[$F{isn_prescricao_pep_is} != null && $F{dsc_descricao_suspensao} != null]]></printWhenExpression>
				</reportElement>
				<box leftPadding="0" bottomPadding="0">
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="0.0"/>
				</box>
				<textElement markup="html">
					<font fontName="SansSerif" size="8" isStrikeThrough="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{dsc_descricao_suspensao}.toUpperCase() +
($F{isn_tipo_prescricao}.equals(1) && $F{isn_dieta}.equals(4)?$F{qtd_dias_dieta_zero}.toUpperCase():"")]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" isBlankWhenNull="true">
				<reportElement stretchType="RelativeToBandHeight" x="113" y="0" width="311" height="15">
					<printWhenExpression><![CDATA[$F{isn_prescricao_pep_is} == null && $F{dsc_prescricao} != null]]></printWhenExpression>
				</reportElement>
				<box leftPadding="0" bottomPadding="0">
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="1.0"/>
				</box>
				<textElement markup="html">
					<font fontName="SansSerif" size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{dsc_prescricao}.toUpperCase() +
($F{isn_tipo_prescricao}.equals(1) && $F{isn_dieta}.equals(4)?$F{qtd_dias_dieta_zero}.toUpperCase():"")]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<columnFooter>
		<band splitType="Stretch"/>
	</columnFooter>
	<pageFooter>
		<band splitType="Stretch"/>
	</pageFooter>
	<summary>
		<band height="88" splitType="Stretch">
			<rectangle>
				<reportElement positionType="Float" x="1" y="7" width="554" height="81"/>
			</rectangle>
			<staticText>
				<reportElement positionType="Float" x="336" y="45" width="100" height="15"/>
				<textElement>
					<font fontName="SansSerif"/>
				</textElement>
				<text><![CDATA[Referência para:]]></text>
			</staticText>
			<staticText>
				<reportElement positionType="Float" x="181" y="44" width="100" height="15"/>
				<textElement>
					<font fontName="SansSerif"/>
				</textElement>
				<text><![CDATA[Observação]]></text>
			</staticText>
			<line>
				<reportElement positionType="Float" x="16" y="77" width="183" height="1"/>
			</line>
			<rectangle>
				<reportElement positionType="Float" x="166" y="46" width="10" height="10"/>
			</rectangle>
			<staticText>
				<reportElement positionType="Float" x="479" y="47" width="57" height="15"/>
				<textElement>
					<font fontName="SansSerif"/>
				</textElement>
				<text><![CDATA[Óbito]]></text>
			</staticText>
			<rectangle>
				<reportElement positionType="Float" x="322" y="47" width="10" height="10"/>
			</rectangle>
			<staticText>
				<reportElement positionType="Float" x="2" y="19" width="554" height="15"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="SansSerif" isBold="true" isUnderline="true"/>
				</textElement>
				<text><![CDATA[ENCAMINHAMENTO - CONDUTA FINAL]]></text>
			</staticText>
			<staticText>
				<reportElement positionType="Float" x="33" y="45" width="68" height="15"/>
				<textElement>
					<font fontName="SansSerif"/>
				</textElement>
				<text><![CDATA[Alta. Conduta]]></text>
			</staticText>
			<rectangle>
				<reportElement positionType="Float" x="466" y="48" width="10" height="10"/>
			</rectangle>
			<rectangle>
				<reportElement positionType="Float" x="16" y="47" width="10" height="10"/>
			</rectangle>
		</band>
	</summary>
</jasperReport>
