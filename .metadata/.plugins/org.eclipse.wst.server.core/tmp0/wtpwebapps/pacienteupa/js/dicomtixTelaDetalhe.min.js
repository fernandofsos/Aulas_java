"use strict";function splitTela(a,b){linhas=a,colunas=b;var c=window.innerWidth-240,d=window.innerHeight-110-.5*a,e=c/b,f=d/a;$("#matrixView").children().each(function(a,b){$(b).remove()});for(var g=0,h=$(studyViewerCopy).find(".thumbnails")[0],i=0;a>i;i++){var j="row"+i;$("#matrixView").append('<div id="'+j+'" class="viewerRows"></div>');for(var k=0;b>k;k++){$("#"+j).append('<div id="column'+k+'" class="viewerCells" style="width:'+e+"px; height:"+f+'px;"></div>');var l="#"+j+" #column"+k;if(g<stacks.length){var m=$("#cellView").clone();m.attr("id","cellView_"+g),$(l).append(m);var n=$(m).find(".viewport")[0];$(n).parent()[0].style.width=e,$(n).parent()[0].style.height=f,mostrarSerie(g,n),0==g&&definirFuncaoBotoes(g,n),elementAtivo=n,$(h).find("a")[g].click(),g++}}}}function mostrarSerie(a,b){function c(a){$(i[0]).text("Zoom:"+a.detail.viewport.scale.toFixed(2)),$(i[1]).text("WW/WL:"+Math.round(a.detail.viewport.voi.windowWidth)+"/"+Math.round(a.detail.viewport.voi.windowCenter)),$(h[1]).text("Render Time:"+a.detail.renderTimeInMs+" ms")}var d=$(b).parent(),e=$(d).find(".overlay"),f=$(e[0]).find("div");$(f[0]).text(studyObj.patientName),$(f[1]).text(studyObj.patientId);var g=$(e[1]).find("div");$(g[0]).text(studyObj.studyDescription),$(g[1]).text(studyObj.studyDate);var h=$(e[2]).find("div"),i=$(e[3]).find("div");b.addEventListener("CornerstoneImageRendered",c,!1);var j=stacks[a].imageIds[0];$(b).attr("serie",a),cornerstone.enable(b),cornerstone.loadAndCacheImage(j).then(function(a){cornerstone.displayImage(b,a),void 0!==stacks[0].frameRate&&stacks[0].frameRate>0&&cornerstone.playClip(b,stacks[0].frameRate),cornerstoneTools.mouseInput.enable(b),cornerstoneTools.mouseWheelInput.enable(b),cornerstoneTools.touchInput.enable(b),cornerstoneTools.wwwc.activate(b,1),cornerstoneTools.pan.activate(b,2),cornerstoneTools.zoom.activate(b,4),cornerstoneTools.probe.enable(b),cornerstoneTools.length.enable(b),cornerstoneTools.ellipticalRoi.enable(b),cornerstoneTools.rectangleRoi.enable(b),cornerstoneTools.wwwcTouchDrag.activate(b),cornerstoneTools.zoomTouchPinch.activate(b),cornerstoneTools.addStackStateManager(b,["playClip"]),cornerstoneTools.addToolState(b,"stack",stacks[0]),cornerstoneTools.stackScrollWheel.activate(b),cornerstoneTools.stackPrefetch.enable(b)}),$(b).on("click touchstart",function(){this!=elementAtivo&&(disableAllTools(elementAtivo),elementAtivo=this,serieAtiva=$(this).attr("serie"),definirFuncaoBotoes(serieAtiva,elementAtivo),cornerstoneTools.stopClip(elementAtivo),cornerstoneTools.stackScroll.disable(elementAtivo),cornerstoneTools.stackScroll.enable(elementAtivo,stacks[serieAtiva],0))})}function loadStudyJson(a){function b(){var b=$(a).find(".studyRow")[0];f.style.width=(window.innerWidth-240)/colunas+"px",f.style.height=(window.innerHeight-110)/linhas+"px",g.style.width=(window.innerWidth-240)/colunas+"px",g.style.height=(window.innerHeight-110)/linhas+"px",e.style.width=(window.innerWidth-240)/colunas+"px",e.style.height=(window.innerHeight-110)/linhas+"px",b.style.height=(window.innerHeight-110)/linhas+"px",f.style.height=(window.innerHeight-120)/linhas+"px",$(j).height(window.innerHeight-110),cornerstone.resize(i,!0)}$("#wadoURL").val();var c=0,d=0;studyObj.seriesList.forEach(function(a){var b={seriesDescription:a.seriesDescription,stackId:a.seriesNumber,imageIds:[],seriesIndex:d,currentImageIdIndex:0,frameRate:a.frameRate};if(void 0!==a.numberOfFrames&&a.numberOfFrames>0)for(var c=a.numberOfFrames,e=0;c>e;e++){var f=a.instanceList[0].imageId+"?frame="+e;"http"!==f.substr(0,4)&&(f=url+f),b.imageIds.push(f)}else a.instanceList.forEach(function(a){var c=a.imageId;"http"!==a.imageId.substr(0,4)&&(c=url+a.imageId),b.imageIds.push(c)});d++,stacks.push(b)});var e=$(a).find(".imageViewer")[0],f=$(e).find(".viewportWrapper")[0],g=$(a).find(".viewer")[0],h=$(a).find(".studyRow")[0],i=($(h).width(),$(a).find(".viewport")[0]);mostrarSerie(c,i),0==c&&(elementAtivo=i),definirFuncaoBotoes(c,i);var j=$(a).find(".thumbnails")[0];stacks.forEach(function(a){var b='<a class="list-group-item" + oncontextmenu="return false"unselectable="on"onselectstart="return false;"onmousedown="return false;"><div class="csthumbnail"oncontextmenu="return false"unselectable="on"onselectstart="return false;"onmousedown="return false;"></div><div class=\'text-center small\'>'+a.seriesDescription+"</div></a>",d=$(b).appendTo(j),e=$(d).find("div")[0];cornerstone.enable(e),cornerstone.loadAndCacheImage(stacks[a.seriesIndex].imageIds[0]).then(function(b){0===a.seriesIndex&&$(d).addClass("active"),cornerstone.displayImage(e,b)}),$(d).on("click touchstart",function(){$("#spanPreConfig").html("Pré-configurações");$(j).find("a").each(function(){$(this).removeClass("active")});$(d).addClass("active"),cornerstoneTools.stopClip(elementAtivo),cornerstoneTools.stackScroll.disable(elementAtivo),cornerstoneTools.stackScroll.enable(elementAtivo,stacks[a.seriesIndex],0),cornerstone.loadAndCacheImage(stacks[a.seriesIndex].imageIds[0]).then(function(b){var d=cornerstone.getDefaultViewport(elementAtivo,b);c=a.seriesIndex,cornerstone.displayImage(elementAtivo,b,d),cornerstone.fitToWindow(elementAtivo);var e=cornerstoneTools.getToolState(elementAtivo,"stack");e.data[0]=stacks[a.seriesIndex],e.data[0].currentImageIdIndex=0,cornerstoneTools.stackPrefetch.enable(elementAtivo);var f=$(elementAtivo).parent(),g=$(f).find(".overlay"),h=$(g[2]).find("div");$(h[1]).text("# Images: "+stacks[a.seriesIndex].imageIds.length),$(h[2]).text("Image #"+(stacks[a.seriesIndex].currentImageIdIndex+1)+"/"+stacks[a.seriesIndex].imageIds.length),serieAtiva=a.seriesIndex,void 0!==stacks[a.seriesIndex].frameRate&&stacks[a.seriesIndex].frameRate>0&&cornerstoneTools.playClip(elementAtivo,stacks[a.seriesIndex].frameRate)})})}),$(window).resize(function(){b()}),b()}function resizeMain(){var a=window.innerHeight;$("#main").height(a-50),$("#tabContent").height(a-50-42)}function disableAllTools(a){cornerstoneTools.wwwc.disable(a),cornerstoneTools.wwwcTouchDrag.deactivate(a),cornerstoneTools.pan.activate(a,2),cornerstoneTools.zoom.activate(a,4),cornerstoneTools.probe.deactivate(a,1),cornerstoneTools.length.deactivate(a,1),cornerstoneTools.ellipticalRoi.deactivate(a,1),cornerstoneTools.rectangleRoi.deactivate(a,1),cornerstoneTools.stackScroll.deactivate(a,1),cornerstoneTools.zoomTouchDrag.deactivate(a),cornerstoneTools.panTouchDrag.deactivate(a),cornerstoneTools.stackScrollTouchDrag.deactivate(a),cornerstoneTools.angle.deactivate(a,1)}function predefinido(a,b,c){disableAllTools(a);var d=cornerstone.getViewport(a);d.voi.windowWidth=Number(b),d.voi.windowCenter=Number(c),cornerstone.setViewport(a,d)}function removeToolState(a,b){var c=cornerstoneTools.getElementToolStateManager(a),d=c.get(a,b);if(d)for(var e=0;e<d.data.length;e++)cornerstoneTools.removeToolState(a,b,d.data[e])}function splitView(a,b){splitTela(a,b)}function apagarFuncaoBotoes(){$("#btn01").off("click touchstart"),$("#btn02").off("click touchstart"),$("#btn03").off("click touchstart"),$("#btn04").off("click touchstart"),$("#btn05").off("click touchstart"),$("#btn06").off("click touchstart"),$("#btn07").off("click touchstart"),$("#btn08").off("click touchstart"),$("#btn09").off("click touchstart"),$("#btn10").off("click touchstart"),$("#btn11").off("click touchstart"),$("#btn12").off("click touchstart"),$("#limparInformacoes").off("click touchstart"),$("a[class='preConfiguracao']").length>0&&$("a[class='preConfiguracao']").each(function(){$(this).off("click touchstart")}),$("a[class='split']").length>0&&$("a[class='split']").each(function(){$(this).off("click touchstart")}),$("#limparImagem").off("click touchstart"),$("#limparSerie").off("click touchstart")}function definirFuncaoBotoes(a,b){function c(a){var c=cornerstoneTools.getToolState(b,"playClip");void 0!==c&&c.data.length>0&&void 0!==c.data[0].intervalId&&void 0!==a.detail.frameRate?$(f[0]).text("FPS: "+Math.round(a.detail.frameRate)):$(f[0]).text().length>0&&$(f[0]).text(""),$(f[2]).text("Image #"+(stacks[serieAtiva].currentImageIdIndex+1)+"/"+stacks[serieAtiva].imageIds.length)}apagarFuncaoBotoes();$(studyViewerCopy).find("button");$("#btn01").on("click touchstart",function(){disableAllTools(b),cornerstoneTools.wwwc.activate(b),cornerstoneTools.wwwcTouchDrag.activate(b)}),$("#btn02").on("click touchstart",function(){disableAllTools(b);var a=cornerstone.getViewport(b);a.invert=a.invert===!0?!1:!0,cornerstone.setViewport(b,a)}),$("#btn03").on("click touchstart",function(){disableAllTools(b),cornerstoneTools.zoom.activate(b,5),cornerstoneTools.zoomTouchDrag.activate(b)}),$("#btn04").on("click touchstart",function(){disableAllTools(b),cornerstoneTools.pan.activate(b,3),cornerstoneTools.panTouchDrag.activate(b)}),$("#btn05").on("click touchstart",function(){disableAllTools(b),cornerstoneTools.stackScroll.activate(b,1),cornerstoneTools.stackScrollTouchDrag.activate(b)}),$("#btn06").on("click touchstart",function(){disableAllTools(b),cornerstoneTools.length.activate(b,1)}),$("#btn07").on("click touchstart",function(){disableAllTools(b),cornerstoneTools.probe.activate(b,1)}),$("#btn08").on("click touchstart",function(){disableAllTools(b),cornerstoneTools.ellipticalRoi.activate(b,1)}),$("#btn09").on("click touchstart",function(){disableAllTools(b),cornerstoneTools.rectangleRoi.activate(b,1)}),$("#btn10").on("click touchstart",function(){var c=stacks[a].frameRate;void 0===c&&(c=10),cornerstoneTools.playClip(b,3)}),$("#btn11").on("click touchstart",function(){cornerstoneTools.stopClip(b)}),$("#btn12").on("click touchstart",function(){disableAllTools(b),cornerstoneTools.angle.activate(b,1)}),$("#limparInformacoes").on("click touchstart",function(){oculto?($(b).find(".overlay").removeAttr("hidden"),$(this).html($(this).html().substr(8))):($(b).find(".overlay").attr("hidden",""),$(this).html("Mostrar "+$(this).html())),oculto=!oculto}),$("a[class='preConfiguracao']").length>0&&$("a[class='preConfiguracao']").each(function(){var a=$(this).attr("title"),c=a.split(",")[0],d=a.split(",")[1];$(this).on("click touchstart",function(){predefinido(b,d,c),$("#spanPreConfig").html(this.innerHTML)})}),$("a[class='split']").length>0&&$("a[class='split']").each(function(){var a=$(this).attr("title"),b=a.split(",")[0],c=a.split(",")[1];$(this).on("click touchstart",function(){splitView(b,c),$("#spanSplit").html($(this).html())})}),$("#limparImagem").on("click touchstart",function(){removeToolState(b,"angle"),removeToolState(b,"ellipticalRoi"),removeToolState(b,"length"),removeToolState(b,"probe"),removeToolState(b,"rectangleRoi"),cornerstone.updateImage(b)}),$("#limparSerie").on("click touchstart",function(){var a=cornerstone.getEnabledElement(b);a.toolStateManager=cornerstoneTools.newImageIdSpecificToolStateManager(),cornerstone.updateImage(b),cornerstoneTools.addStackStateManager(b,["playClip"]),cornerstoneTools.addToolState(b,"stack",stacks[0]),cornerstoneTools.stackScrollWheel.activate(b),cornerstoneTools.stackPrefetch.enable(b)}),b.removeEventListener("CornerstoneNewImage");var d=$(b).parent(),e=$(d).find(".overlay"),f=$(e[2]).find("div");b.addEventListener("CornerstoneNewImage",c,!1)}var url=dicomtixConfig.url_imagem,oculto=!1,colunas=1,linhas=1,studyObj=JSON.parse(window.opener.document.getElementById("dicomtixExameObj").value),usuarioObj=JSON.parse(window.opener.document.getElementById("dicomtixUsuarioObj").value);window.opener.close(),document.title=studyObj.patientName;var studyViewerCopy=$("#studyViewerTemplate").clone();studyViewerCopy.attr("id","x"+studyObj.patientId),studyViewerCopy.removeClass("hidden"),studyViewerCopy.appendTo("#tabContent"),document.getElementById("spanNomeUsuario").innerHTML=usuarioObj.nome;var preConfig={CR:[{label:"Padrao",wl:"1600",ww:"2800"},{label:"[20/40]",wl:"20",ww:"40"},{label:"[40/80]",wl:"40",ww:"80"},{label:"[80/160]",wl:"80",ww:"160"},{label:"[160/320]",wl:"160",ww:"320"},{label:"[320/640]",wl:"320",ww:"640"},{label:"[640/1280]",wl:"640",ww:"1280"},{label:"[1280/2560]",wl:"1280",ww:"2560"},{label:"[2560/5120]",wl:"2560",ww:"5120"}],CT:[{label:"Padrao",wl:"-65",ww:"1016"},{label:"Abdomen",wl:"60",ww:"400"},{label:"Angio",wl:"300",ww:"600"},{label:"Bone",wl:"300",ww:"1500"},{label:"Brain",wl:"40",ww:"80"},{label:"Chest",wl:"40",ww:"400"},{label:"Lungs",wl:"-400",ww:"1500"}],DX:[{label:"Padrao",wl:"2047",ww:"4095"},{label:"[20/40]",wl:"20",ww:"40"},{label:"[40/80]",wl:"40",ww:"80"},{label:"[80/160]",wl:"80",ww:"160"},{label:"[160/320]",wl:"160",ww:"320"},{label:"[320/640]",wl:"320",ww:"640"},{label:"[640/1280]",wl:"640",ww:"1280"},{label:"[1280/2560]",wl:"1280",ww:"2560"},{label:"[2560/5120]",wl:"2560",ww:"5120"}],MG:[{label:"Padrao",wl:"8046",ww:"15956"},{label:"[30/60]",wl:"30",ww:"60"},{label:"[125/250]",wl:"125",ww:"250"},{label:"[500/1000]",wl:"500",ww:"1000"},{label:"[1875/3750]",wl:"1875",ww:"3750"},{label:"[3750/7500]",wl:"3750",ww:"7500"},{label:"[7500/15000]",wl:"7500",ww:"15000"},{label:"[15000/30000]",wl:"15000",ww:"30000"},{label:"[30000/60000]",wl:"30000",ww:"60000"}],MR:[{label:"Padrao",wl:"393",ww:"787"},{label:"[30/60]",wl:"30",ww:"60"},{label:"[125/250]",wl:"125",ww:"250"},{label:"[500/1000]",wl:"500",ww:"1000"},{label:"[1875/3750]",wl:"1875",ww:"3750"},{label:"[3750/7500]",wl:"3750",ww:"7500"},{label:"[7500/15000]",wl:"7500",ww:"15000"},{label:"[15000/30000]",wl:"15000",ww:"30000"},{label:"[30000/60000]",wl:"30000",ww:"60000"}]},menuPreConfiguracoes=$("#menuPreConfiguracoes")[0];if(studyObj.modality&&menuPreConfiguracoes&&preConfig[studyObj.modality]&&preConfig[studyObj.modality].length>0)for(var i=0;i<preConfig[studyObj.modality].length;i++){var a=document.createElement("a");a.setAttribute("class","preConfiguracao"),a.href="#",a.title=preConfig[studyObj.modality][i].wl+","+preConfig[studyObj.modality][i].ww,a.innerHTML=preConfig[studyObj.modality][i].label;var li=document.createElement("li");li.appendChild(a),menuPreConfiguracoes.appendChild(li)}var stacks=[],elementAtivo=null,serieAtiva=0;$(window).resize(function(){resizeMain()}),resizeMain(),$("#tabs a:last").tab("show"),$('a[data-toggle="tab"]').on("shown.bs.tab",function(){$(window).trigger("resize")}),loadStudyJson(studyViewerCopy),$("#btn01").tooltip(),$("#btn02").tooltip(),$("#btn03").tooltip(),$("#btn04").tooltip(),$("#btn05").tooltip(),$("#btn06").tooltip(),$("#btn07").tooltip(),$("#btn08").tooltip(),$("#btn09").tooltip(),$("#btn10").tooltip(),$("#btn11").tooltip(),$("#btn12").tooltip(),document.body.addEventListener("touchmove",function(a){a.preventDefault()});